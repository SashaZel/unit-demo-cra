name: Tag release

on: 
    push:
        tags:
            - '*'

permissions:
      issues: write
      contents: read
      pages: write
      id-token: write

jobs:
  create_issue:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    # steps:
    #   - name: Create issue using REST API
    #     run: |
    #       curl --request POST \
    #       --url https://api.github.com/repos/${{ github.repository }}/issues \
    #       --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
    #       --header 'content-type: application/json' \
    #       --data '{
    #         "title": "Automated issue for commit: ${{ github.sha }}",
    #         "body": "This issue was automatically created by the GitHub Action workflow **${{ github.workflow }}**. \n\n The commit hash was: _${{ github.sha }}_."
    #         }' \
    #       --fail
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - name: Instal Oktokit SDK
        run: npm install @octokit/core
      - name: run ci file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          GH_ACTOR: ${{ github.actor }}
          GH_REF_NAME: ${{ github.ref_name }}
          GH_SHA: ${{ github.sha }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: node ./ci/createIssue.js
      - name: Install packages
        run: npm ci
      - name: Unit testing
        run: CI=true npm test
      - name: Build app
        run: npm run build
      - name: Setup Pages
        uses: actions/configure-pages@v3
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          # Upload entire repository
          path: './build'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      #  env:
      #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      